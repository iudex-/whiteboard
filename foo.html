<!DOCTYPE html>
<html>
<head>
<title>whiteboard</title>
</head>
<style>
body {
	margin: 0;
	padding: 0;
}
div {
	margin: 0;
	padding: 0;
}

#container {
	margin: 0 auto;
	width: 90%
}
#canvas {
	/*border: 1px solid #ccc;*/
}
#footer {
	position: fixed;
	left: 0;
	bottom: 0;
	background: #ccc;
	width: 100%;
}
span {
	padding-right: 20px;
}

#colorpicker {
    width: 30px;
    height: 30px;
    position: fixed;
    top: 0;
    right:0;
}
</style>
<body>
    <input type="color" id="colorpicker" />
	<canvas id="canvas" width="500" height="500"></canvas>
<div id="footer">
	clients:
	<span id="clients"></span>
	x:
	<span id="x"></span>
	y:
	<span id="y"></span>
	<span><input type="button" id="clear"value="clear" /></span>
</div>
<script src="./socket.io/socket.io.js"></script>
<script>
var points = [];

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
//var color = "#ff0000";
var color = 'rgb('+Math.floor(Math.random()*256)+','+Math.floor(Math.random()*256)+','+Math.floor(Math.random()*256)+')';

canvas.width = window.innerWidth;
canvas.height = window.innerHeight-10;
/*
window.onresize = function(e){
	canvas.width = window.innerWidth-2;
	canvas.height = window.innerHeight-10;
} */

ctx.fillStyle = color;
ctx.strokeStyle = color;
ctx.lineWidth = 3.0;
ctx.lineCap = 'round';
ctx.lineJoin = 'round';

var xx = document.getElementById('x');
var yy = document.getElementById('y');

var clearlnk = document.getElementById("clear");
clearlnk.onmousedown = function(e) {
	send(JSON.stringify({'clear': true}));
	//clear();
}
console.log(clearlnk);

var colorpicker = document.getElementById("colorpicker");
colorpicker.onchange = function() {
    color = colorpicker.value;
    console.log("picked color: "+color);
}


ctx.beginPath();
var x = null;
var y = null;
var draw = false;

canvas.onmousedown = function(e) {
	x = e.clientX;
	y = e.clientY;
	x -= canvas.offsetLeft;
	y -= canvas.offsetTop;
	draw = true;
	xx.innerHTML = x;
	yy.innerHTML = y;

    ctx.fillStyle = color;
    ctx.strokeStyle = color;

	ctx.closePath();
	ctx.arc(x, y, 2, 0, Math.PI*2, true); 
	ctx.closePath();
	ctx.fill();
	ctx.beginPath();

	ctx.moveTo(x, y);
	points[points.length] = [x,y];
};

canvas.onmouseup = function(e) {
	draw = false;
	//console.log(points);
	if(points.length>0) {
		var msgobj= {'draw': {'color': color, 'points': points}};
		console.log(msgobj);
		send(JSON.stringify( msgobj ));
	}
	points = [];
};
canvas.onmousemove = function(e) {
	x = e.clientX;
	y = e.clientY;
	x -= canvas.offsetLeft;
	y -= canvas.offsetTop;
	xx.innerHTML = x;
	yy.innerHTML = y;

	if (!draw) {
		return;
	}
	
	ctx.lineTo(x, y);
	ctx.stroke();
	ctx.moveTo(x, y);
	points[points.length] = [x,y];
};

var clear = function() {
	//canvas.width = canvas.width;
	ctx.clearRect(0,0,canvas.width,canvas.height);
	return false;
}

var drawpoints = function(a,c) {
	ctx.closePath();
	ctx.fillStyle = c;
	ctx.strokeStyle = c;
	ctx.beginPath();
	if(a.length>1) {
		ctx.moveTo(a[0][0], a[0][1]);
		for(var i=0; i<a.length; i++) {
			var point = a[i];
			ctx.lineTo(point[0], point[1]);
			ctx.stroke();
			ctx.moveTo(point[0], point[1]);
		}
	} else if(a.length=1) {
		ctx.arc(a[0][0], a[0][1], 2, 0, Math.PI*2, true); 
		ctx.closePath();
		ctx.fill();
	}
	ctx.fillStyle = color;
	ctx.strokeStyle = color;
	ctx.beginPath();
};

var socket = new io.connect();
console.log(socket);
socket.on('connect',function() {
	console.log('Client has connected to the server!');
});
socket.on('message', function(data){
		data = JSON.parse(data)
		console.log(data);
		if(data.clients) document.getElementById('clients').innerHTML = data.clients;
		if(data.draw && data.draw.points && data.draw.points.length>0) drawpoints(data.draw.points,data.draw.color);
		if(data.clear) clear();
	});

socket.on('disconnect',function() {
	console.log('The client has disconnected!');
});
function send(message) {
	socket.send(message);
}


var viergewinnt = function(){
	send(JSON.stringify({'draw':{'color':'#000000','points':[
		[50,50],[400,50],[400,350],[50,350],[50,50],
		[100,50],[100,350],[150,350],[150,50],[200,50],[200,350],[250,350],[250,50],[300,50],[300,350],[350,350],[350,50],
		[400,50],[400,100],[50,100],[50,150],[400,150],[400,200],[50,200],[50,250],[400,250],[400,300],[50,300]
	]}}));   
}
</script>
</body>
